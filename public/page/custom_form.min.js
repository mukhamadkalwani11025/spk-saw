/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

const FormHelper = {
    /**
     * Menangani form request
     * @param {object} form Elemen form 
     * @param {object} $urlController Url string dari attribut action form
     * @param {object} $btnSubmit Elemen tombol submit milik form
     * @param {object} $btnLoading Elemen tombol loading milik form
     * @param {object} options opsi tambahan jika dibutuhkan
     * @returns 
     */
    submitForm: function (
        form,
        $urlController,
        $btnSubmit,
        $btnLoading,
        options = {}
    ) {
        const {
            formCek: formCek = null,
            $tabelData: $tabelData = null,
            $modalDiv: $modalDiv = null,
            $btnClose: $btnClose = null,
        } = options;
        const handleOptions = {
            formCek: formCek,
            $tabelData: $tabelData,
            $modalDiv: $modalDiv,
            ...options,
        };
        return (
            $.ajax({
                url: $urlController,
                type: "POST",
                data: $(form).serialize(),
                dataType: "json",
                beforeSend: function () {
                    $btnSubmit.hide(),
                        $btnLoading.show(),
                        $btnClose && $btnClose.hide();
                },
                success: function (response) {
                    FormHelper.handleResponse(form, response, handleOptions);
                },
                error: function (xhr) {
                    let msg =
                        xhr.responseJSON?.message ||
                        xhr.responseText ||
                        "Terjadi kesalahan saat memproses.";
                    Swal.fire("Gagal", msg, "error");
                },
                complete: function () {
                    $btnSubmit.show();
                    $btnLoading.hide();
                    $btnClose && $btnClose.show();
                },
            }),
            !1
        );
    },

    /**
     * Menangani respon dari server dan menentukan tampilan respon
     * @param {object} form Elemen form 
     * @param {object} response objek respon dari server
     * @param {object} options opsi tambahan jika dibutuhkan
     */
    handleResponse: function (form, response, options = {}) {
        const finalOptions = {
            formCek: null,
            $tabelData: null,
            $modalDiv: null,
            reload: !1,
            ...options,
        };
        if (response.success)
            Swal.fire({
                icon: "success",
                title: "Sukses",
                text: response.message,
            }).then(() => {
                if (
                    (finalOptions.formCek &&
                        "function" ==
                            typeof finalOptions.formCek.resetInitial &&
                        finalOptions.formCek.resetInitial(),
                    finalOptions.$tabelData &&
                        finalOptions.$tabelData.DataTable)
                ) {
                    const dtInstance = options.$tabelData.DataTable();
                    dtInstance &&
                        (dtInstance.ajax.reload(null, !1).draw(!1),
                        Beranda.refreshCsrf());
                }

                // reload statistik bila function tersedia
                if (
                    finalOptions.$options &&
                    typeof finalOptions.$options.loadStats === "function"
                ) {
                    finalOptions.$options.loadStats();
                }

                finalOptions.$modalDiv && finalOptions.$modalDiv.modal("hide"),
                    finalOptions.reload && location.reload();

                // reset validasi input
                FormHelper.resetFormValidation(finalOptions.$modalDiv);
            });
        else {
            const validator = $(form).data("validator");
            validator && "object" == typeof response.messages
                ? (validator.showErrors(response.messages),
                  Swal.fire({
                      icon: "error",
                      title: "Validasi Gagal!",
                      text: "Silakan periksa kembali input Anda.",
                  }))
                : Swal.fire({
                      icon: "error",
                      title: "Gagal!",
                      text: response.messages,
                  });
        }
    },

    /**
     * Helper untuk mengecek perubahan pada data form.
     * Menggunakan closure untuk menyimpan data awal form.
     *
     * @param {object} formSelector Elemen form jQuery atau selector string.
     * @returns {{isChanged: function, resetInitial: function}}
     */
    cekFormData: function (formSelector) {
        let $form = $(formSelector);
        if ($form.attr("data-cek") !== "true") {
            return { isChanged: () => true, resetInitial: () => {} };
        }

        let initialData = {};

        function setInitialData() {
            initialData = {};
            $form.find("input, select, textarea").each(function () {
                let name = $(this).attr("name");
                if (!name) return;
                if ($(this).is(":checkbox, :radio")) {
                    initialData[name] = $(this).is(":checked");
                } else {
                    initialData[name] = $(this).val();
                }
            });
        }

        function checkChanged() {
            let changed = false;
            $form.find("input, select, textarea").each(function () {
                let name = $(this).attr("name");
                if (!name) return;
                let currentVal = $(this).is(":checkbox, :radio")
                    ? $(this).is(":checked")
                    : $(this).val();
                if (currentVal != initialData[name]) {
                    changed = true;
                    return false;
                }
            });

            if (!changed) {
                $form.find(":input").removeClass("is-invalid is-valid");
                Swal.fire({
                    icon: "info",
                    title: "Informasi",
                    html: "Data input tidak ada perubahan. <br> Proses simpan dibatalkan.",
                    confirmButtonText: "OK",
                });
            }
            return changed;
        }

        setInitialData();
        return { isChanged: checkChanged, resetInitial: setInitialData };
    },

    /**
     * Fungsi untuk mengatur opsi validasi form
     * Mengembalikan konfigurasi validasi jQuery.validate
     * yang dapat digunakan kembali untuk berbagai jenis form.
     */
    validasiForm: function () {
        return {
            ignore: [],
            errorElement: "span",
            errorClass: "invalid-feedback",
            highlight: function (element) {
                $(element).addClass("is-invalid").removeClass("is-valid");
            },
            unhighlight: function (element) {
                $(element).removeClass("is-invalid").addClass("is-valid");
            },
            errorPlacement: function (error, element) {
                const $parent = element.closest(".input-group, .form-group");
                if ($parent.length) {
                    $parent.append(error);
                } else if (
                    element.is(".select") ||
                    element.hasClass("select2") ||
                    element.hasClass("selectpicker")
                ) {
                    error.insertAfter(element.next());
                } else {
                    error.insertAfter(element);
                }
            },
        };
    },

    /**
     * Validasi email custom
     * @param {string} email email yang akan dievaluasi 
     * @returns 
     */
    IsEmail(email) {
        const regex =
            /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        return regex.test(email);
    },

    // Fungsi kapital awal huruf
    hurufKapitalAwal() {
        const input = $(this).val();
        if (input.length > 0) {
            const capitalized = input.charAt(0).toUpperCase() + input.slice(1);
            $(this).val(capitalized);
        }
    },

    // Fungsi buka-tutup input password
    cekpwd() {
        let $passwordInputs = $(
            "#password,#password_confirmation,#edit_password,#edit_password_confirmation"
        );

        if ($passwordInputs.first().attr("type") === "password") {
            // ubah semua jadi text
            $passwordInputs.attr("type", "text");
            $(".toggle-password i")
                .removeClass("bi-eye-fill")
                .addClass("bi-eye-slash-fill");
        } else {
            // ubah semua jadi password
            $passwordInputs.attr("type", "password");
            $(".toggle-password i")
                .removeClass("bi-eye-slash-fill")
                .addClass("bi-eye-fill");
        }
    },

    // Reset input
    resetFormValidation(target) {
        const $modal = $(target);
        const $form = $modal.closest("form");
        if ($form.length) {
            $form[0].reset();
            $form
                .find(".is-invalid, .is-valid")
                .removeClass("is-invalid is-valid");
            $form.find(".invalid-feedback, .valid-feedback").remove();
        }
    },
};

// Menambahkan metode validasi kustom jika plugin jQuery Validate dimuat
if (typeof $.validator !== "undefined") {
    $.validator.addMethod(
        "customEmail",
        function (value, element) {
            return FormHelper.IsEmail(value);
        },
        "Email tidak valid (contoh: user@example.com)"
    );
}

// Menambah event input ketika user mengetik pada input class .upper
$(document).on("input", "input.upper", FormHelper.hurufKapitalAwal);

// Menambah event click ketika user klik pada tombol class .toggle-password
$(document).on("click", ".toggle-password", FormHelper.cekpwd);




