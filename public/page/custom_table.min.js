/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

const TableHelper = {
    /**
     * Inisialisasi DataTable dengan konfigurasi gabungan (default + custom)
     * @param {string} selector - selector tabel (contoh: "#tableUserList")
     * @param {object} options - konfigurasi tambahan spesifik
     */
    init: function (selector, options = {}) {
        const defaultConfig = {
            paging: true,
            searching: true,
            ordering: true,
            info: true,
            autoWidth: false,
            responsive: true,
            processing: true,
            serverSide: false,
            order: [[0, "asc"]],
            dom: `
                <"row mb-2"<"col-sm-2"B><"col-sm-2"l><"col-sm-8"f>>
                <"row"<"col-sm-12"tr>>
                <"row mt-2"<"col-sm-5"i><"col-sm-7"p>>
            `,
            buttons: {
                dom: {
                    container: { className: "dt-buttons" },
                    button: { className: "dt-button btn btn-sm" },
                },
                buttons: [],
            },
            initComplete: function () {
                console.log();
                const api = this.api();
                const tableId = $(this).attr("id");
                const filterContainer = $(`#${tableId}_filter`);
                const extraFilters = $(
                    '<div class="ml-2 d-inline-block"></div>'
                );

                // kolom mana saja yang diberi filter otomatis
                const filterCols = options.filters || [];
                if (filterCols.length) {
                    api.columns(filterCols).every(function () {
                        const column = this;
                        const headerText = $(column.header()).text().trim();
                        const select = $(`
                            <select class="form-control form-control-sm d-inline-block w-auto mr-1">
                                <option value="">Semua ${headerText}</option>
                            </select>
                        `)
                            .appendTo(extraFilters)
                            .on("change", function () {
                                const val = $.fn.dataTable.util.escapeRegex(
                                    $(this).val()
                                );
                                column
                                    .search(
                                        val ? "^" + val + "$" : "",
                                        true,
                                        false
                                    )
                                    .draw();
                            });

                        column
                            .cells(null, column.index(), { search: "applied" })
                            .render("display")
                            .unique()
                            .sort()
                            .each(function (d) {
                                const text = $("<div>").html(d).text().trim();
                                if (text.length)
                                    select.append(
                                        `<option value="${text}">${text}</option>`
                                    );
                            });
                    });

                    filterContainer.append(extraFilters);
                }
            },
        };

        // Gabungkan konfigurasi default dan custom
        const config = $.extend(true, {}, defaultConfig, options);

        // Inisialisasi tabel
        return $(selector).DataTable(config);
    },

    /**
     * Render kolom tanggal dan waktu
     * Digunakan di konfigurasi kolom: render: TableHelper.tabelTanggalWaktu
     */
    tabelTanggalWaktu: function (data, type) {
        if (!data) return "-";
        if (type !== "display") return data;
        const [tanggal, waktu] = data.split(" ");
        const formattedTanggal = FormatHelper.formatTanggal(tanggal);
        return `${formattedTanggal} â†’ ${waktu || ""}`;
    },
};
