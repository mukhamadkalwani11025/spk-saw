/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

const Beranda = {
    refreshCsrf: function () {
        const token = document.querySelector('meta[name="csrf-token"]');
        token &&
            $.ajaxSetup({
                headers: { "X-CSRF-TOKEN": token.getAttribute("content") },
            });
    },
    progressModal: $("#progressModal"),
    progressBar: $(".progress-bar"),
    aksiAjax: function (
        btn,
        judul,
        teks,
        icon,
        url,
        {
            useLoading: useLoading = !1,
            onSuccess: onSuccess = null,
            onError: onError = null,
        } = {}
    ) {
        $(document).on("click", btn, function (e) {
            e.preventDefault(),
                Swal.fire({
                    title: judul,
                    html: teks,
                    icon: icon,
                    showCancelButton: !0,
                    confirmButtonColor: "#d33",
                    confirmButtonText: "Submit",
                }).then((result) => {
                    if (!result.isConfirmed) return;
                    let timer = null,
                        startTime = null;
                    function hideLoading() {
                        clearInterval(timer);
                        const elapsed = (Date.now() - startTime) / 1e3,
                            delay = elapsed < 0.5 ? 500 - 1e3 * elapsed : 0;
                        Beranda.progressBar.css("width", "100%").text("100 %"),
                            setTimeout(
                                () => Beranda.progressModal.modal("hide"),
                                delay + 200
                            );
                    }
                    useLoading &&
                        (function showLoading() {
                            Beranda.progressBar.css("width", "1%").text("0 %"),
                                Beranda.progressModal.modal("show"),
                                (startTime = Date.now());
                            let progress = 1;
                            timer = setInterval(() => {
                                progress < 90 &&
                                    (progress++,
                                    Beranda.progressBar
                                        .css("width", progress + "%")
                                        .text(progress + " %"));
                            }, 30);
                        })(),
                        $.ajax({
                            url: url,
                            type: "POST",
                            dataType: "json",
                            success: function (res) {
                                useLoading && hideLoading(),
                                    res.success
                                        ? Swal.fire(
                                              "Berhasil",
                                              res.messages,
                                              "success"
                                          ).then(() => {
                                              Beranda.refreshCsrf(),
                                                  "function" ==
                                                      typeof onSuccess &&
                                                      onSuccess(res);
                                          })
                                        : Swal.fire({
                                              icon: "error",
                                              title: "Error",
                                              text: res.messagess,
                                              confirmButtonText: "OK",
                                          });
                            },
                            error: function (xhr) {
                                useLoading && hideLoading();
                                let msg =
                                    xhr.responseJSON?.messages ||
                                    xhr.responseText ||
                                    "Terjadi kesalahan saat proses.";
                                Swal.fire("Error", msg, "error"),
                                    "function" == typeof onError &&
                                        onError(xhr);
                            },
                        });
                });
        });
    },
};
